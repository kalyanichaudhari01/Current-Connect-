<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>News Aggregator</title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />

    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 40px;
        padding-bottom: 120px;
      }
      .container {
        max-width: 1200px;
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
      }

      #filterForm {
        margin-bottom: 30px;
      }

      #newsFeed {
        margin-top: 20px;
      }
      .news-card {
        margin-bottom: 30px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .news-card img {
        object-fit: cover;
        width: 100%;
        height: 200px;
      }

      #paginationContainer {
        margin-top: 20px;
      }

      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #343a40;
        color: #fff;
        text-align: center;
        padding: 10px 0;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>News Aggregator</h1>

      <form id="filterForm" class="row g-3">
        <div class="col-md-4">
          <label for="categorySelect" class="form-label"
            >Select Category:</label
          >

          <select id="categorySelect" class="form-select">
            <option value="all">All</option>
            <option value="technology">Technology</option>
            <option value="sport">Sport</option>
            <option value="politics">Politics</option>
            <option value="business">Business</option>
            <option value="culture">Culture</option>
            <option value="environment">Environment</option>
            <option value="lifeandstyle">Lifestyle</option>
            <option value="travel">Travel</option>
          </select>
        </div>
        <div class="col-md-4 align-self-end">
          <button type="submit" class="btn btn-primary">Update News</button>
        </div>
      </form>

      <div id="newsFeed" class="row"></div>

      <div
        id="paginationContainer"
        class="d-flex justify-content-center align-items-center"
      ></div>
    </div>

    <footer>News Aggregator - Bocaletto Luca</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let currentPage = 1;
      let totalPages = 1;
      let currentCategory = "all";
      const pageSize = 20;

      const filterForm = document.getElementById("filterForm");
      const categorySelect = document.getElementById("categorySelect");
      const newsFeed = document.getElementById("newsFeed");
      const paginationContainer = document.getElementById(
        "paginationContainer"
      );

      function buildApiUrl(category, page) {
        const baseUrl = "https://content.guardianapis.com/search";
        const apiKey = "test";
        const additionalParams = `&show-fields=thumbnail,trailText&page-size=${pageSize}`;
        let sectionParam = "";
        if (category !== "all") {
          sectionParam = "&section=" + category;
        }
        return `${baseUrl}?api-key=${apiKey}${sectionParam}${additionalParams}&page=${page}`;
      }

      async function fetchNews(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) {
            console.error("Response status: " + response.status);
            throw new Error("Network response not OK: " + response.status);
          }
          const json = await response.json();
          return json;
        } catch (error) {
          console.error("Error fetching news:", error);
          return null;
        }
      }

      function displayNews(data) {
        newsFeed.innerHTML = "";

        if (!data || !data.response || !data.response.results) {
          newsFeed.innerHTML =
            "<p class='text-center text-danger'>No news data available.</p>";
          return;
        }

        currentPage = data.response.currentPage;
        totalPages = data.response.pages;

        const results = data.response.results;

        results.forEach((article) => {
          const colDiv = document.createElement("div");
          colDiv.className = "col-12 col-md-6 col-lg-4";

          const card = document.createElement("div");
          card.className = "card news-card h-100";

          if (article.fields && article.fields.thumbnail) {
            const img = document.createElement("img");
            img.src = article.fields.thumbnail;
            img.alt = article.webTitle;
            img.className = "card-img-top";
            card.appendChild(img);
          }

          const cardBody = document.createElement("div");
          cardBody.className = "card-body d-flex flex-column";

          const title = document.createElement("h5");
          title.className = "card-title";
          title.textContent = article.webTitle;
          cardBody.appendChild(title);

          if (article.fields && article.fields.trailText) {
            const trailText = document.createElement("p");
            trailText.className = "card-text";

            trailText.innerHTML = article.fields.trailText;
            cardBody.appendChild(trailText);
          }

          const readMore = document.createElement("a");
          readMore.className = "btn btn-sm btn-primary mt-auto";
          readMore.href = article.webUrl;
          readMore.target = "_blank";
          readMore.textContent = "Read More";
          cardBody.appendChild(readMore);

          card.appendChild(cardBody);
          colDiv.appendChild(card);
          newsFeed.appendChild(colDiv);
        });

        updatePaginationControls();
      }

      function updatePaginationControls() {
        paginationContainer.innerHTML = "";

        const prevBtn = document.createElement("button");
        prevBtn.className = "btn btn-secondary me-2";
        prevBtn.textContent = "Previous";
        prevBtn.disabled = currentPage <= 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            loadNews(currentPage - 1);
          }
        });

        const nextBtn = document.createElement("button");
        nextBtn.className = "btn btn-secondary ms-2";
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage >= totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            loadNews(currentPage + 1);
          }
        });

        const pageInfo = document.createElement("span");
        pageInfo.className = "mx-2";
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        paginationContainer.appendChild(prevBtn);
        paginationContainer.appendChild(pageInfo);
        paginationContainer.appendChild(nextBtn);
      }

      async function loadNews(page = 1) {
        currentCategory = categorySelect.value;
        currentPage = page;
        const url = buildApiUrl(currentCategory, currentPage);
        newsFeed.innerHTML = "<p class='text-center'>Loading news...</p>";
        const data = await fetchNews(url);
        if (data) {
          displayNews(data);
        } else {
          newsFeed.innerHTML =
            "<p class='text-center text-danger'>Error fetching news. Please try again later.</p>";
        }
      }

      filterForm.addEventListener("submit", function (event) {
        event.preventDefault();
        loadNews(1);
      });

      loadNews(1);
    </script>
  </body>
</html>
